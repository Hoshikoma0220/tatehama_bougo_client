# TrainCrew軌道回路・ゾーン表示機能の説明

## 実装した機能

メインウィンドウ（Form1）に以下の機能を追加しました：

### 1. TrainCrew連携表示エリア
- **接続状態ラベル**: TrainCrewとの接続状況をリアルタイム表示
- **列車情報ラベル**: 現在運転している列車の列車番号を表示
- **軌道回路リストボックス**: 自列車が現在在線している軌道回路の一覧
- **ゾーン情報ラベル**: ZoneMapping.csvと照合した現在のゾーン表示

### 2. 効率的なデータ取得
TrainCrew APIの`tconlyontrain`を使用して、自列車が在線している軌道回路のみを効率的に取得します。

## TrainCrew API仕様に基づく実装

### WebSocket接続
- **接続先**: `ws://127.0.0.1:50300/`
- **プロトコル**: WebSocket通信でリアルタイムデータ取得

### データ要求コマンド
```json
{
  "command": "DataRequest",
  "args": ["tconlyontrain"]
}
```

### 自列車軌道回路の特定方法

1. **効率的な要求**: `tconlyontrain`で自列車が在線している軌道回路のみを要求
2. **確実な絞り込み**: 受信データから以下の条件で自列車の軌道回路を特定
   - `trackCircuit.On == true` （軌道回路が在線状態）
   - `trackCircuit.Last == myTrainData.diaName` （最後に通過した列車が自分）

### ゾーンマッピング
`ZoneMapping.csv`を読み込み、軌道回路名からゾーンへの変換を行います：
- 複数の軌道回路に在線している場合、該当するゾーンも複数表示
- 重複するゾーンは除去して表示

## 使用方法

### 1. TrainCrewの準備
- TrainCrewのゲーム本体を起動するか、デバッガーを起動してWebSocket APIを有効にしてください
- APIは`ws://127.0.0.1:50300/`で待機している必要があります

### 2. アプリケーションの起動
1. このアプリケーションを起動
2. **起動と同時に**自動的にTrainCrewへの接続を試行開始
3. 接続成功後、3秒間隔で定期的にデータ要求を送信
4. **堅牢な接続管理**により、ゲーム起動のタイミングに関係なく自動接続

### 3. 表示内容
- **接続状態**: 
  - 「TrainCrew: 接続中 - 最終受信: HH:mm:ss」（緑色、正常時）
  - 「TrainCrew: 接続試行中...」（赤色、接続試行中）
  - 「TrainCrew: エラー: [詳細] - 3秒後に再接続」（赤色、エラー時）
- **列車番号**: 「列車番号: [ダイヤ名]」
- **軌道回路一覧**: 現在在線している軌道回路の名前を一覧表示
- **現在のゾーン**: 「現在のゾーン: ゾーン1, ゾーン2」（複数ゾーンの場合はカンマ区切り）

## 実装のポイント

### 1. 堅牢な接続管理
- **アプリ起動時即座に接続開始**: コンストラクタで早期に接続プロセスを開始
- **短間隔での再接続**: 接続失敗時は3秒間隔で積極的に再試行
- **接続ヘルスチェック**: 10秒間隔で接続状態を監視、データ受信が30秒途絶えた場合は自動再接続
- **詳細な状態表示**: 最終データ受信時刻を表示してユーザーに現在の状況を明示

### 2. 非同期処理とスレッドセーフ
- WebSocket通信は別スレッドで実行
- UI更新は`Invoke`を使用してメインスレッドで実行
- 定期的なデータ要求は`System.Threading.Timer`で実装（3秒間隔に短縮）
- 接続状態チェック用の追加タイマー

### 2. エラーハンドリング
- **積極的な自動再接続**: 接続失敗・エラー・タイムアウト時は3秒間隔で再試行
- **フォーム表示の安定性**: TrainCrewクライアント初期化エラーがフォーム表示を妨げない設計
- JSON解析エラー時のフォールバック処理
- ゾーンマッピング読み込みエラーの適切な処理
- **接続ヘルスチェック**: データ受信が途絶えた場合の自動検出・再接続
- **UI操作の安全性**: すべてのUI更新でInvokeRequiredチェックとエラーハンドリング

### 3. データ効率性
- `tconlyontrain`を使用して必要最小限のデータのみ取得
- 重複ゾーンの除去で表示をすっきり保持
- 3秒間隔での定期データ要求でリアルタイム性を向上

## 起動タイミングに依存しない設計

### アプリケーション先行起動の場合
1. アプリケーション起動
2. TrainCrewが未起動でも3秒間隔で接続を試行し続ける
3. TrainCrewが起動次第、自動的に接続・データ取得開始

### TrainCrew先行起動の場合
1. TrainCrewが既に起動済み
2. アプリケーション起動と同時に即座に接続成功
3. すぐにデータ取得開始

### ゲーム中の接続断
1. ネットワーク問題やTrainCrewの一時停止を自動検出
2. 3秒間隔で自動再接続を試行
3. TrainCrew復旧次第、即座にデータ取得再開

## ファイル構成

### 追加・修正されたファイル
- `Form1.cs`: メインウィンドウにTrainCrew表示機能を追加
- `TrainCrewWebSocketClient.cs`: WebSocket通信とデータ処理を担当
- `TrainCrewData.cs`: TrainCrew API のデータ構造定義（既存）
- `ZoneMapping.csv`: 軌道回路名からゾーンへのマッピング（既存）

### 必要なNuGetパッケージ
- `WebSocketSharp-netstandard`: WebSocket通信
- `Newtonsoft.Json`: JSON解析

## トラブルシューティング

### フォームが起動しない場合
1. TrainCrewクライアントの初期化エラーが原因の可能性があります
2. **解決済み**: TrainCrewクライアントの初期化をLoad時に移動し、エラーハンドリングを強化
3. 初期化に失敗してもフォーム表示は正常に行われます

### 接続できない場合
1. TrainCrewのゲーム本体またはデバッガーが起動していることを確認
2. `ws://127.0.0.1:50300/`でAPIが待機していることを確認
3. ファイアウォール設定を確認

### 軌道回路が表示されない場合
1. TrainCrewでゲームが実際に開始されていることを確認
2. 列車が軌道回路上に在線していることを確認
3. デバッグ出力でJSON受信データを確認

### ゾーンが表示されない場合
1. `ZoneMapping.csv`ファイルが存在することを確認
2. 軌道回路名がZoneMapping.csvに定義されていることを確認
3. CSV形式が正しいことを確認（TrackCircuitName,Zone）

## デバッグ情報

アプリケーションは詳細なデバッグ情報を出力します：
- WebSocket接続状況
- 受信データの内容
- JSON解析結果
- 軌道回路からゾーンへのマッピング結果

Visual StudioまたはVS Codeのデバッグコンソールで確認できます。
